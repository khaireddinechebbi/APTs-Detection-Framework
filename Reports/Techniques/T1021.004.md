# Technical Detection Report: SSH Remote Management Activity

## Overview

This report analyzes suspicious remote management activities targeting VMware ESXi/vCenter infrastructure through PowerShell PowerCLI commands and Plink-based SSH connections. The attacks demonstrate techniques for enabling SSH services on ESXi hosts to facilitate lateral movement and persistent access.

## Attack Summary

- **MITRE Technique:** T1021.004 (Remote Services: SSH)
- **Primary Tactics:** Lateral Movement, Execution
- **Description:** Attackers use PowerShell PowerCLI commands and Plink SSH connections to remotely enable SSH services on VMware ESXi hosts, creating persistent access channels for lateral movement within virtualized environments.

## Attack Chain Analysis

The attack follows a multi-stage approach that leverages both legitimate management tools and SSH utilities to enable remote access to ESXi hosts. The following flowchart details the exact steps and highlights where the Sigma rule's detection logic triggers on the immutable components of the attack.

```mermaid
flowcard TD
A["‚ù∂ Initial Execution<br>PowerShell Process"] --> B["PowerShell Process<br>Image: powershell.exe"];

subgraph B1[Phase 1: PowerCLI vCenter Management]
    B2["Immutable Technique:<br>Connect-VIServer Authentication<br>Sigma Detection: 'Connect-VIServer'"]
    B2 --> B3["Service Discovery:<br>Get-VMHostService + TSM-SSH Filter<br>Sigma Detection: 'Get-VMHostService' + 'TSM-SSH'"]
    B3 --> B4["Service Modification:<br>Start-VMHostService/Stop-VMHostService<br>Sigma Detection: Service control commands"]
end

B --> B1;
B4 --> C["SSH Service State Change<br>on ESXi Host"];

D["Phase 2: Plink SSH Execution"] --> E["Command Process<br>Image: cmd.exe"];

subgraph E1[SSH Command Injection]
    E2["Immutable Technique:<br>Plink Execution<br>Sigma Detection: 'plink.exe'"]
    E2 --> E3["SSH Connection Parameters:<br>-ssh flag + credentials<br>Sigma Detection: '-ssh'"]
    E3 --> E4["ESXi Command Execution:<br>vim-cmd hostsvc enable/disable<br>Sigma Detection: 'vim-cmd' + 'enable_ssh'/'disable_ssh'"]
end

E --> E1;
E4 --> F["SSH Service Modified<br>Remote access established"];

G["Sigma Rule Detection"] -.->|Triggers on| B2
G -.->|Triggers on| B3
G -.->|Triggers on| B4
G -.->|Triggers on| E2
G -.->|Triggers on| E3
G -.->|Triggers on| E4

H["vCenter/ESXi Infrastructure"] <-.-> B1
H <-.-> E1
```

## Immutable Detection Points

### 1. PowerCLI vCenter Authentication
**Indicator:** `Connect-VIServer` command
**Why Immutable:** This is the standard PowerCLI cmdlet for connecting to vCenter/ESXi hosts and cannot be changed without breaking functionality.

### 2. ESXi Service Management
**Indicator:** `Get-VMHostService` with `TSM-SSH` filter
**Why Immutable:** The TSM-SSH service key is the official identifier for SSH services in VMware ESXi and cannot be altered.

### 3. Service Control Commands
**Indicator:** `Start-VMHostService`/`Stop-VMHostService`
**Why Immutable:** These are the official PowerCLI cmdlets for managing ESXi services with fixed names.

### 4. Plink SSH Execution
**Indicator:** `plink.exe` with `-ssh` parameter
**Why Immutable:** Plink is the command-line SSH client from PuTTY with fixed executable name and parameter syntax.

### 5. ESXi Management Commands
**Indicator:** `vim-cmd hostsvc/enable_ssh` and `vim-cmd hostsvc/disable_ssh`
**Why Immutable:** These are the official vSphere API commands for SSH service management with fixed syntax.

## Sigma Rule Analysis

### Rule Effectiveness
The Sigma rule `Suspicious SSH Remote Management Activity (vCenter/Plink)` effectively targets all immutable components of this attack:

```yaml
detection:
  selection_vcenter_pwsh:
    EventID: 1
    Image|endswith: '\powershell.exe'
    CommandLine|contains_all:
      - 'Connect-VIServer'
      - 'Get-VMHostService'
      - 'TSM-SSH'
  selection_plink_cmd:
    EventID: 1
    Image|endswith: '\cmd.exe'
    CommandLine|contains_all:
      - 'plink.exe'
      - '-ssh'
      - 'vim-cmd'
    CommandLine|contains_any:
      - 'enable_ssh'
      - 'disable_ssh'
  condition: selection_vcenter_pwsh or selection_plink_cmd
```

### Detection Logic
The rule triggers when these immutable elements appear in process creation events:

1. **PowerCLI vCenter Management:** Detection of `Connect-VIServer`, `Get-VMHostService`, and `TSM-SSH` patterns in PowerShell
2. **Plink SSH Execution:** Presence of `plink.exe` with SSH parameters and vim-cmd enable/disable commands in cmd.exe

As shown in the flowchart, the Sigma rule detects both the PowerCLI-based approach and the Plink-based approach to SSH service manipulation, providing comprehensive coverage against this technique.

### False Positive Considerations
**Legitimate Administrative Activities:**
```powershell
# Approved vCenter automation scripts
Connect-VIServer -Server vcenter.company.com -User admin -Password ****
Get-VMHostService -VMHost esxi01.company.com | Where-Object {$_.Key -eq "TSM-SSH"}
Start-VMHostService -Confirm:$false

# Authorized SSH management for maintenance
plink.exe -batch esxi01.company.com -ssh -l root -pw "****" "vim-cmd hostsvc/enable_ssh"
```

**Enterprise Management Patterns:**
- Automated vCenter configuration management scripts
- CI/CD pipelines that deploy to ESXi hosts
- Backup and recovery operations requiring SSH access
- Security compliance scanning and remediation

## Mitigation Recommendations

1. **Access Control:** Restrict PowerCLI and Plink execution to authorized administrative accounts only
2. **Network Segmentation:** Isolate vCenter/ESXi management interfaces from general network access
3. **Monitoring:** Enhance auditing of vCenter API calls and SSH service state changes
4. **Service Hardening:** Disable SSH services on ESXi hosts when not required for operations
5. **Authentication Controls:** Implement multi-factor authentication for vCenter access
6. **Logging:** Enable comprehensive logging of vSphere API operations and SSH access attempts

## Conclusion

This attack demonstrates sophisticated techniques for enabling remote access to virtual infrastructure through legitimate management tools. The detection rule provides high-fidelity alerting by focusing on the immutable technical components that attackers cannot change without breaking their attack chain. The combination of specific PowerCLI cmdlets, service identifiers, and Plink command patterns creates a reliable detection signature for identifying unauthorized SSH service manipulation.

The Sigma rule effectively covers both primary attack methodologies while maintaining specificity through the requirement of multiple correlated indicators. Organizations should implement this detection while establishing appropriate exception processes for legitimate vCenter administration and automation activities, particularly focusing on the timing and context of SSH service modifications rather than blocking the tools entirely.