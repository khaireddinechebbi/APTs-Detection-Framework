# Technical Detection Report: PowerShell Command and Scripting Interpreter Abuse

## Overview
This report analyzes a Sigma rule designed to detect suspicious PowerShell execution patterns associated with MITRE ATT&CK technique **T1059.001 (Command and Scripting Interpreter: PowerShell)**. The analysis covers multiple attack variants including encoded commands, remote execution, suspicious cmdlets, and registry manipulation.

## Attack Summary
- **MITRE Technique:** T1059.001 (Command and Scripting Interpreter: PowerShell)
- **Primary Tactics:** Execution (TA0002), Defense Evasion (TA0005)
- **Description:** Adversaries abuse PowerShell for various malicious activities including code execution, credential dumping, lateral movement, and persistence establishment.

## Attack Chain Analysis
The following flowchart details the attack patterns across multiple tests and how the Sigma rule detects them:

```mermaid
flowchart TD
A["❶ Initial Execution Vector<br>Multiple entry points"] --> B["PowerShell Process<br>Image: powershell.exe"];

B --> C1;
B --> C2;
B --> C3;
B --> C4;
B --> C5;
B --> C6;

subgraph C1[Technique 1: COM Object Abuse]
    D1["Immutable Technique:<br>MsXml2.ServerXmlHttp COM Object<br>Sigma Detection: 'New-Object' + '.ServerXmlHttp'"]
    D1 --> D2["HTTP Request Methods:<br>.Open + .Send + .ResponseText<br>Sigma Detection: Method chain detection"]
end

subgraph C2[Technique 2: Encoded Commands]
    E1["Immutable Technique:<br>EncodedCommand Parameter<br>Sigma Detection: '-e'/'enc'/'encodedcommand'"]
    E1 --> E2["Base64 Decoding Execution:<br>IEX or direct execution<br>Sigma Detection: Encoded argument patterns"]
end

subgraph C3[Technique 3: Remote Management]
    F1["Immutable Technique:<br>New-PSSession + Test-Connection<br>Sigma Detection: 'New-PSSession' + '-ComputerName'"]
    F1 --> F2["File Operations:<br>Set-Content/Get-Content in TEMP<br>Sigma Detection: TEMP path patterns"]
end

subgraph C4[Technique 4: Known Malicious Cmdlets]
    G1["Immutable Technique:<br>PowerSploit/PowerUp Cmdlets<br>Sigma Detection: 40+ known malicious cmdlet names"]
    G1 --> G2["Offensive Tool Functions:<br>Invoke-Mimikatz, Get-GPPPassword, etc.<br>Sigma Detection: Specific function names"]
end

subgraph C5[Technique 5: Registry-Based Execution]
    H1["Immutable Technique:<br>reg.exe with encoded payload<br>Sigma Detection: 'reg.exe add' + '/d' parameter"]
    H1 --> H2["Parent Process Context:<br>PowerShell spawning reg.exe<br>Sigma Detection: Parent-child relationship"]
end

subgraph C6[Technique 6: WMI Context Execution]
    I1["Immutable Technique:<br>WmiPrvSE.exe parent process<br>Sigma Detection: ParentImage: WmiPrvSE.exe"]
    I1 --> I2["Encoded Arguments:<br>-NoProfile with encoded data<br>Sigma Detection: Argument patterns"]
end

C1 --> J["Remote Code Execution<br>Via HTTP requests"];
C2 --> K["Obfuscated Execution<br>Base64 decoded payloads"];
C3 --> L["Lateral Movement<br>Remote session management"];
C4 --> M["Privilege Escalation<br>Known offensive tools"];
C5 --> N["Persistence<br>Registry payload storage"];
C6 --> O["WMI-based Execution<br>Legitimate system context"];

P["Sigma Rule Detection"] -.->|Triggers on| D1
P -.->|Triggers on| D2
P -.->|Triggers on| E1
P -.->|Triggers on| F1
P -.->|Triggers on| F2
P -.->|Triggers on| G1
P -.->|Triggers on| H1
P -.->|Triggers on| H2
P -.->|Triggers on| I1
P -.->|Triggers on| I2
```

## Immutable Detection Points

### 1. MSXML COM Object Patterns
**Indicator:** `New-Object`, `.ServerXmlHttp`, `.Open`, `.Send`, `.ResponseText`
**Why Immutable:** These are specific .NET class names and method names required for HTTP requests via COM.

### 2. Encoded Command Parameters
**Indicator:** `-e`, `-enc`, `-encodedcommand`, `/enc`, `/encodedcommand`
**Why Immutable:** These are the official parameter names for encoded command execution in PowerShell.

### 3. PSSession and Network Patterns
**Indicator:** `New-PSSession`, `-ComputerName`, `Test-Connection`, `Set-Content`, `Get-Content`
**Why Immutable:** These are fixed cmdlet names and parameter names for remote sessions and file operations.

### 4. Malicious Cmdlet Names
**Indicator:** PowerSploit cmdlets like `Invoke-Mimikatz`, `Get-GPPPassword`, `PowerUp`, `PowerView`
**Why Immutable:** These are the specific function names from well-known offensive PowerShell frameworks.

### 5. Registry Manipulation Patterns
**Indicator:** `reg.exe add /d` with PowerShell parent containing `Set-Content`
**Why Immutable:** This combination indicates encoded payload storage in registry.

### 6. WMI Parent with Encoding
**Indicator:** PowerShell with `-NoProfile` and encoding flags spawned from `WmiPrvSE.exe`
**Why Immutable:** This pattern suggests WMI-based PowerShell execution with obfuscation.

### 7. Stealthy Cleanup Operations
**Indicator:** `Remove-Item -Force -ErrorAction Ignore` targeting temp files or registry
**Why Immutable:** This specific syntax indicates evidence removal attempts.

## Sigma Rule Analysis

### Rule Effectiveness
The Sigma rule uses a comprehensive multi-pattern approach with seven distinct detection scenarios:

```yaml
detection:
  suspicious_patterns|1: # MSXML COM objects (Test 6)
  suspicious_patterns|2: # Encoded commands (Tests 14-17)
  suspicious_patterns|3: # PSSession & operations (Test 12)
  suspicious_patterns|4: # Malicious cmdlets (Test 18)
  suspicious_patterns|5: # Registry manipulation (Test 10)
  suspicious_patterns|6: # WMI parent with encoding
  suspicious_patterns|7: # Stealth cleanup
  
  condition: (1 of suspicious_patterns)
```

### Detection Coverage
- **Test 6:** MSXML COM object HTTP requests → Detected by `suspicious_patterns|1`
- **Test 10:** Fileless registry execution → Detected by `suspicious_patterns|5` 
- **Test 12:** PSSession and lateral movement → Detected by `suspicious_patterns|3`
- **Tests 14-16:** Various encoded command patterns → Detected by `suspicious_patterns|2`
- **Test 17:** Obfuscated execution → Detected by `suspicious_patterns|2`
- **Test 18:** Malicious cmdlet execution → Detected by `suspicious_patterns|4`

### False Positive Considerations
**Potential false positive scenarios:**

```powershell
# Legitimate administrative scripts
powershell.exe -EncodedCommand VwByAGkAdABlAC0ASABvAHMAdAAgACIASABlAGwAbABvACIA

# System management tasks
New-PSSession -ComputerName server01
Test-Connection server02

# DevOps automation
Set-Content -Path config.json -Value $config
```

**Realistic assessment:** The combination of multiple specific patterns significantly reduces false positives. Most legitimate usage doesn't combine these techniques in suspicious ways.

## Mitigation Recommendations

1. **PowerShell Hardening:** Implement Constrained Language Mode and disable legacy protocols
2. **Application Control:** Restrict PowerShell execution through AppLocker or WDAC
3. **Logging Enhancement:** Enable PowerShell module logging and script block logging
4. **Network Monitoring:** Detect unusual PowerShell network activity and remote sessions
5. **User Training:** Educate administrators about PowerShell security risks
6. **Endpoint Protection:** Deploy EDR solutions with PowerShell behavior monitoring

## Conclusion

The Sigma rule provides comprehensive detection for T1059.001 techniques across multiple test scenarios. The rule correctly focuses on immutable components of these attacks—specific cmdlet names, parameter patterns, method invocations, and execution behaviors—that adversaries cannot easily alter without breaking functionality.

The multi-pattern approach with seven distinct detection scenarios provides robust coverage for various attack techniques while maintaining reasonable specificity. The rule effectively identifies PowerShell abuse for code execution, lateral movement, credential access, and defense evasion, providing valuable coverage for one of the most common attack techniques in Windows environments.