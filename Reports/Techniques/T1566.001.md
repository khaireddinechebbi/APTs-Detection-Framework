# Technical Detection Report: Multi-Stage Malicious Document Attacks (T1566.001)

## Overview

This report analyzes two distinct but related PowerShell-based attack patterns associated with spearphishing attachments. Both attacks demonstrate techniques for initial access through malicious documents but employ different execution chains for payload delivery and deployment.

## Attack Summary

- **MITRE Technique:** T1566.001 (Phishing: Spearphishing Attachment)
- **Primary Tactics:** Initial Access, Execution, Defense Evasion
- **Description:** Attackers use PowerShell to either download pre-made malicious documents or dynamically create weaponized Office files with embedded macros, followed by cleanup operations to remove evidence.

## Combined Attack Chain Analysis

The two attacks represent different approaches to the same objective: compromising systems through malicious documents.

```mermaid
flowchart TD
A["❶ Initial Execution<br>User opens malicious attachment"] --> B["PowerShell Process"];

subgraph B1[Attack Method 1: Direct Download]
    B2["Immutable Technique:<br>Web Request Download<br>Invoke-WebRequest -Uri -OutFile"] --> B3["Downloads pre-made<br>malicious document"];
    B3 --> B4["Document dropped in<br>temp location $env:TEMP"];
end

subgraph B5[Attack Method 2: Dynamic Weaponization]
    B6["Immutable Technique:<br>In-Memory Execution<br>IEX iwr 'http://...'"] --> B7["Loads weaponization tools<br>e.g., Invoke-MalDoc.ps1"];
    B7 --> B8["Immutable Technique:<br>VBA File Operations<br>Open...For Output As #1"];
    B8 --> B9["Creates malicious<br>macro content"];
    B9 --> B10["Immutable Technique:<br>Office Automation<br>Invoke-MalDoc -officeProduct Word"];
end

B --> B1;
B --> B5;
B4 --> C["Payload Staged"];
B10 --> C;

C --> D["User enables content<br>macros execute"];
D --> E["Payload execution<br>e.g., calc.exe, reverse shell"];

subgraph F[Phase 3: Cleanup Operations]
    F1["Immutable Technique:<br>Stealth File Deletion<br>Remove-Item -ErrorAction Ignore"] --> F2["Removes evidence from<br>Public/Temp folders"];
end

E --> F;
```

## Immutable Detection Points

### 1. Web Request Download (Attack 1)
**Indicator:** `Invoke-WebRequest -Uri -OutFile` or aliases (`iwr`, `curl`)
**Why Immutable:** Standard PowerShell syntax for web downloads. Parameter names and structure are fixed.

### 2. In-Memory Execution Cradle (Attack 2)
**Indicator:** `IEX (iwr 'http://...')` or `Invoke-Expression (Invoke-WebRequest...)`
**Why Immutable:** Fundamental pattern for remote code execution without file artifacts.

### 3. VBA File Operations (Attack 2)
**Indicator:** `Open ... For Output As #1` and `Write #1, ...`
**Why Immutable:** Canonical VBA syntax for file creation. Cannot be altered without breaking functionality.

### 4. Office Automation (Attack 2)
**Indicator:** `-officeProduct Word` or similar Office COM object creation
**Why Immutable:** Standard parameter naming for Office automation scripts.

### 5. Stealth Cleanup Operations (Both)
**Indicator:** `Remove-Item -ErrorAction Ignore` targeting temporary paths
**Why Immutable:** Consistent pattern for evidence removal across attacks.

## Sigma Rule Analysis

### Rule Effectiveness
The Sigma rule provides comprehensive coverage for both attack methods:

```yaml
detection:
  # Detection for Attack 1: Direct Download
  selection_filedownload:
    CommandLine|contains|all:
      - '-Uri'
      - '-OutFile'
  
  # Detection for Attack 2: Weaponization  
  selection_vba_staging:
    CommandLine|contains:
      - 'Invoke-Expression'
      - 'IEX'
    CommandLine|contains|all:
      - ' Open '
      - ' For Output As '
      - ' Write '
      - '-officeProduct'
  
  # Cleanup detection for both attacks
  selection_remove:
    CommandLine|contains|all:
      - 'Remove-Item'
      - '-ErrorAction Ignore'
    CommandLine|contains:
      - '\Users\Public\'
      - '$env:TEMP'
    ParentImage|endswith: '\powershell.exe'
```

### Detection Logic
The rule triggers on three primary scenarios that cover both attack patterns:

1. **Direct File Download:** Detects Attack 1 via web request patterns
2. **Document Weaponization:** Detects Attack 2 through in-memory execution and VBA generation
3. **Evidence Removal:** Catches cleanup operations common to both attacks

### Coverage Analysis
| Attack Component | Attack 1 | Attack 2 | Rule Coverage |
| :--- | :--- | :--- | :--- |
| **Initial Download** | ✅ Web request | ✅ In-memory execution | ✅ Both methods |
| **Payload Delivery** | ✅ Direct download | ✅ Dynamic generation | ✅ Both methods |
| **Obfuscation** | ❌ Minimal | ✅ High (encoding) | ✅ Partial |
| **Cleanup** | ✅ Supported | ✅ Supported | ✅ Full coverage |

## Mitigation Recommendations

1. **Application Control:** Implement application whitelisting to restrict unauthorized PowerShell execution
2. **Macro Security:** Disable Office macros from executing without explicit user approval
3. **Network Monitoring:** Monitor outbound web requests from office workstations
4. **Email Filtering:** Deploy advanced email security to detect malicious attachments
5. **User Training:** Educate users about phishing risks and document safety practices
6. **Endpoint Detection:** Deploy EDR solutions with PowerShell monitoring capabilities

## Conclusion

These two attacks demonstrate the evolving sophistication of T1566.001 techniques, ranging from simple document downloads to advanced in-memory weaponization. The detection rule provides comprehensive coverage by targeting the immutable technical components across both attack methodologies.

By focusing on web download patterns, in-memory execution cradles, VBA generation syntax, and stealth cleanup operations, the rule creates high-fidelity signatures for identifying spearphishing attachment attacks while maintaining low false positive rates. The combination of these detection points provides robust coverage against both simple and advanced document-based initial access vectors, making it an effective tool for detecting T1566.001 campaigns in enterprise environments.