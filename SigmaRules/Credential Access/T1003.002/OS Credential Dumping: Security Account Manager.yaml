title: Registry Hive Dump Attempts via reg.exe, esentutl.exe, or Temp Cleanup (Sysmon)
id: 8f2c5a1b-3d9a-4b2d-b7f3-1a2f5e4c6d7e
status: experimental
description: |
  Detects attempts to dump sensitive registry hives (SAM, SYSTEM, SECURITY) 
  using reg.exe, esentutl.exe, or follow-up cleanup of dumped files via cmd/powershell.
author: Khaireddine
date: 2025/09/08
logsource:
  product: windows
  category: process_creation
  service: sysmon

detection:
  reg_img:
    Image|endswith: '\reg.exe'
  reg_parent:
    ParentImage|endswith:
      - '\cmd.exe'
      - '\powershell.exe'
  reg_cmd:
    CommandLine|contains:
      - ' save '
      - ' export '
  reg_hive:
    CommandLine|contains:
      - '\sam'
      - '\system'
      - '\security'
  cleanup_img:
    Image|endswith:
      - '\cmd.exe'
      - '\powershell.exe'
  cleanup_cmd:
    CommandLine|contains|all:
      - 'del'
      - '>nul'
      - '2>'
      - '%temp%'
  cleanup_hive:
    CommandLine|contains:
      - '\sam'
      - '\SAM'
      - '\system'
      - '\security'
  esentutl_img:
    Image|endswith: '\cmd.exe'
  esentutl_cmd:
    CommandLine|contains|all:
      - 'esentutl.exe'
      - '%SystemRoot%/system32/config/SAM'
      - '%temp%/SAM'

  condition: (reg_img and reg_parent and reg_cmd and reg_hive)
          or (cleanup_img and cleanup_cmd and cleanup_hive)
          or (esentutl_img and esentutl_cmd)

fields:
  - UtcTime
  - Image
  - CommandLine
  - ParentImage
  - ParentCommandLine
  - User

falsepositives:
  - Legitimate registry backups or system diagnostics
  - Forensic/IR activities copying hives
level: high
tags:
  - attack.credential_access
  - attack.t1003
  - attack.t1003.002
