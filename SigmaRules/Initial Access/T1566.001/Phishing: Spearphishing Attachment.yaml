title: Suspicious PowerShell Malicious Document Activity
id: 6f8d7d83-6cb4-4b35-8f43-90e6e4a1a6a9
status: experimental
description: Detects PowerShell activity consistent with malicious document delivery and execution, such as downloading Excel macro-enabled files, invoking malicious expressions that fetch/execute remote content (including .jse payloads), and removing artifacts from user/temp locations. This behavior is commonly observed with spearphishing attachments and post-exploitation downloader/loader activity (T1566.001).
author: Khaireddine
date: 2025/09/16
logsource:
  product: windows
  category: process_creation
  service: sysmon
detection:
  select_image:
    EventID: 1
    Image|endswith: '\powershell.exe' 
  selection_web:
    CommandLine|contains:
      - 'Invoke-WebRequest'
      - 'iwr'
  selection_protocol:
    CommandLine|contains:
      - 'http://'
      - 'https://'
  selection_filedownload:
    CommandLine|contains|all:
      - '-Uri'
      - '-OutFile'
      - 'Net.SecurityProtocolType'

  selection_vba_staging:
    CommandLine|contains:
      - 'Invoke-Expression'
      - 'IEX'
      - 'iex'
    CommandLine|contains|all:
      - ' Open '
      - ' For Output As '
      - ' Write '
      - '-officeProduct'
      - 'Word'

    ParentImage|endswith: '\powershell.exe'
  condition: 
    select_image and (
    (selection_web and selection_filedownload and selection_protocol)
    or (selection_vba_staging and selection_web and selection_protocol)
    )
fields:
  - UtcTime
  - Image
  - CommandLine
  - ParentImage
  - ParentCommandLine
  - User
falsepositives:
  - Legitimate administrative scripts downloading or cleaning up files
  - Developers/testers using PowerShell to fetch or remove files (including teams testing macros or script packaging)
  - Automation that decodes/executes signed scripts in controlled environments
level: high
tags:
  - attack.initial_access
  - attack.t1566
  - attack.t1566.001
  - attack.execution
