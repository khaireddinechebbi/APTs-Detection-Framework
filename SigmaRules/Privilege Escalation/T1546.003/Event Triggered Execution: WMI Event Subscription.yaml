title: Suspicious PowerShell WMI Persistence
id: 3e5c2f61-3b19-44b1-a8d0-4e43d2c5b911
status: experimental
description: Detects suspicious PowerShell commands related to WMI persistence via event subscription, mofcomp, or deletion of WMI objects in the root\subscription namespace.
author: Khaireddine
date: 2025/09/14
logsource:
  product: windows
  category: process_creation
  service: sysmon
detection:
  selection|wmi:
    EventID: 1
    Image|endswith: '\powershell.exe'
    CommandLine|contains|all:
      - '__EventFilter'
      - '__FilterToConsumerBinding'
    CommandLine|contains:
      - 'CommandLineEventConsumer'
      - 'ActiveScriptEventConsumer'
  selection|mof:
    EventID: 1
    Image|endswith: '\powershell.exe'
    CommandLine|contains|all:
      - 'mofcomp.exe'
      - '.mof'
  selection|cleanup:
    EventID: 1
    Image|endswith: '\powershell.exe'
    CommandLine|contains|all:
      - 'Get-WmiObject'
      - 'Remove-WmiObject'
      - '-ErrorAction SilentlyContinue'
  condition: 1 of selection
fields:
  - UtcTime
  - Image
  - CommandLine
  - ParentImage
  - ParentCommandLine
  - User
falsepositives:
  - Legitimate administrative WMI scripting
  - Management frameworks relying on WMI subscriptions
level: high
tags:
  - attack.persistence
  - attack.privilege_escalation
  - attack.t1546.003
