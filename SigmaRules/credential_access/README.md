#KQL code
T1003.002:
    winlog.channel:"Microsoft-Windows-Sysmon/Operational" and event.code:1 and process.name:"reg.exe" and ((process.args:"save" and (process.args:"HKLM\\sam" or process.args:"HKLM\\system" or process.args:"HKLM\\security")) or (process.command_line:("* save *") and (process.command_line:("*hklm\\sam*" or "*hklm\\system*" or "*hklm\\security*"))))

T1003.004:
    winlog.channel:"Microsoft-Windows-Sysmon/Operational" and event.code:1 and ((process.name:"reg.exe" and ((process.args:"save" and process.args:("HKLM\\sam" or "HKLM\\system" or "HKLM\\security" or "HKLM\\security\\policy\\secrets")) or (process.command_line:("* save *") and process.command_line:("*hklm\\sam*" or "*hklm\\system*" or "*hklm\\security*" or "*hklm\\security\\policy\\secrets*")))) or (process.name:("powershell.exe" or "pwsh.exe") and process.command_line:("*http*" or "*https*") and (process.command_line:("*DownloadString*" or "*Invoke-WebRequest*" or "*Invoke-Expression*" or "*IEX*"))) or (process.name:"PsExec.exe" and process.command_line:("* reg save *") and process.command_line:("*hklm\\sam*" or "*hklm\\system*" or "*hklm\\security*" or "*hklm\\security\\policy\\secrets*")) or (process.name:"reg.exe" and process.parent.name:"PSEXESVC.exe" and (process.args:"HKLM\\security\\policy\\secrets" or process.command_line:*HKLM\\security\\policy\\secrets*)) or (process.name:"PSEXESVC.exe"))