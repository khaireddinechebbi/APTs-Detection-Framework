title: Advanced SAM/LSA Secrets Access and Cleanup (Sysmon)
id: d3a6f8b2-9c4e-4f9b-a2b1-8f7e6c5d4a3b
status: experimental
description: |
  Detects suspicious activity related to SAM/LSA secrets access and cleanup.
  Includes reg.exe dumping secrets via PsExec, PowerShell downloading malicious scripts,
  and command-line deletion of temporary secrets files.
author: Khaireddine
date: 2025/08/18
logsource:
  product: windows
  category: process_creation
  service: sysmon
detection:
  reg_from_psexesvc:
    Image|endswith: '\reg.exe'
    ParentImage|endswith: '\PSEXESVC.exe'
    CommandLine|contains|all:
      - 'reg'
      - ' save '
      - '\security\policy\secrets'
      - '\Temp\secrets'
  powershell_http:
    Image|endswith:
      - '\powershell.exe'
    CommandLine|contains|all:
      - 'Invoke-Expression'
      - 'WebClient'
      - 'DownloadString'
      - '.ps1'
    CommandLine|contains_any:
      - 'http'
      - 'https'
  cleanup_temp:
    Image|endswith:
      - '\cmd.exe'
      - '\powershell.exe'
    CommandLine|contains|all:
      - 'del'
      - '>nul'
      - '2>'
      - '%temp%'
      - '\secrets'
  condition: reg_from_psexesvc or powershell_http or cleanup_temp
fields:
  - UtcTime
  - Image
  - CommandLine
  - ParentImage
  - ParentCommandLine
  - User
falsepositives:
  - Legitimate registry backup operations using reg.exe
  - Administrative use of PsExec for registry export during troubleshooting
  - PowerShell scripts legitimately downloading automation modules or updates
  - Cleanup commands removing temp files during maintenance
level: high
tags:
  - attack.credential_access
  - attack.t1003
  - attack.t1003.004
