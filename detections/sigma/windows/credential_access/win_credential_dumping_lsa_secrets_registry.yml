title: Advanced SAM/LSA Secrets Access (Sysmon)
id: d3a6f8b2-9c4e-4f9b-a2b1-8f7e6c5d4a3b
status: experimental
description: Detects attempts to access SAM, SYSTEM, SECURITY hives or LSA secrets via reg.exe, PsExec, or PowerShell downloads.
author: Khaireddine
date: 2025/08/18
logsource:
  product: windows
  category: process_creation
  service: sysmon
detection:
  reg_save:
    Image|endswith:
      - '\reg.exe'
    CommandLine|contains:
      - ' save '
    CommandLine|contains_any:
      - 'hklm\sam'
      - 'hklm\system'
      - 'hklm\security'
      - 'hklm\security\policy\secrets'
  powershell_http:
    Image|endswith:
      - '\powershell.exe'
      - '\pwsh.exe'
    CommandLine|contains_any:
      - 'http'
      - 'https'
    CommandLine|contains_any:
      - 'DownloadString'
      - 'Invoke-WebRequest'
      - 'Invoke-Expression'
      - 'IEX'
  psexec_reg:
    Image|endswith: '\PsExec.exe'
    CommandLine|contains: ' reg save '
    CommandLine|contains_any:
      - 'hklm\sam'
      - 'hklm\system'
      - 'hklm\security'
      - 'hklm\security\policy\secrets'
  reg_from_psexesvc:
    Image|endswith: '\reg.exe'
    ParentImage|endswith: '\PSEXESVC.exe'
    CommandLine|contains_any:
      - 'hklm\security\policy\secrets'
  condition: reg_save or powershell_http or psexec_reg or reg_from_psexesvc or Image|endswith('\PSEXESVC.exe')
fields: [ UtcTime, Image, CommandLine, ParentImage, ParentCommandLine, User ]
falsepositives: [ Admin scripts performing registry backups, PsExec usage in maintenance ]
level: high
tags: [ attack.credential_access, attack.t1003, attack.t1003.004 ]
